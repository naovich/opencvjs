<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>OpenCV.js Webcam Demo</title>
    <style>
      /* Le CSS reste inchangé */
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: #222;
        color: white;
        font-family: Arial, sans-serif;
      }
      .container {
        display: flex;
        gap: 20px;
        margin: 20px;
      }
      .video-container {
        position: relative;
        width: 640px;
        height: 480px;
      }
      video,
      canvas {
        width: 640px;
        height: 480px;
        background: #000;
      }
      #status {
        margin: 20px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <h2>Démonstration OpenCV.js Webcam</h2>
    <p id="status">OpenCV.js est en cours de chargement...</p>

    <div class="container">
      <div class="video-container">
        <h3>Webcam Original</h3>
        <video id="videoInput" autoplay playsinline></video>
      </div>
      <div class="video-container">
        <h3>Niveau de Gris</h3>
        <canvas id="canvasOutput"></canvas>
      </div>
    </div>

    <!-- Ajout de l'attribut disabled -->
    <button id="startButton" disabled>Démarrer la Webcam</button>

    <script type="text/javascript">
      let video = document.getElementById("videoInput");
      let startButton = document.getElementById("startButton");
      let streaming = false;
      let stream = null;

      function processVideo() {
        if (!streaming) return;

        // Création des matrices OpenCV avec les bonnes dimensions
        const height = video.videoHeight;
        const width = video.videoWidth;
        let src = new cv.Mat(height, width, cv.CV_8UC4);
        let dst = new cv.Mat(height, width, cv.CV_8UC1);
        let cap = new cv.VideoCapture(video);

        cap.read(src);
        cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);
        cv.imshow("canvasOutput", dst);

        src.delete();
        dst.delete();

        requestAnimationFrame(processVideo);
      }

      async function startCamera() {
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { width: 640, height: 480 },
            audio: false,
          });

          video.srcObject = stream;

          await new Promise((resolve) => {
            video.onloadedmetadata = () => {
              video.play();
              resolve();
            };
          });

          await new Promise((resolve) => requestAnimationFrame(resolve));

          streaming = true;
          startButton.textContent = "Arrêter la Webcam";
          processVideo();
        } catch (err) {
          console.error("Erreur:", err);
          document.getElementById("status").innerHTML =
            "Erreur de caméra: " + err.message;
        }
      }

      function stopCamera() {
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
          video.srcObject = null;
          streaming = false;
          startButton.textContent = "Démarrer la Webcam";
        }
      }

      startButton.addEventListener("click", () => {
        if (!streaming) {
          startCamera();
        } else {
          stopCamera();
        }
      });

      // Configuration du Module OpenCV
      var Module = {
        onRuntimeInitialized() {
          document.getElementById("status").innerHTML = "OpenCV.js est prêt.";
          startButton.disabled = false; // Activation du bouton
          console.log("OpenCV.js est initialisé");
        },
      };
    </script>
    <!-- Chargement synchrone pour garantir l'ordre d'initialisation -->
    <script src="https://docs.opencv.org/4.x/opencv.js" async></script>
  </body>
</html>
